name: Upload to TestPyPI

on:
  workflow_dispatch:  # This allows only manual triggering

jobs:
  upload-to-pypi:
    runs-on: ubuntu-latest
    steps:
    - name: Download artifacts
      uses: actions/github-script@v6
      with:
        script: |
          async function downloadArtifact(workflowName, artifactName) {
            const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const matchingArtifact = allArtifacts.data.artifacts.find((artifact) => {
              return artifact.name == artifactName
            });
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchingArtifact.id,
              archive_format: 'zip',
            });
            const fs = require('fs');
            fs.writeFileSync('${{github.workspace}}/' + artifactName + '.zip', Buffer.from(download.data));
          }
          await downloadArtifact("Build Windows Wheels", "windows-wheels");
          await downloadArtifact("Build Manylinux Wheels", "manylinux-wheels");

    - name: Unzip artifacts
      run: |
        unzip -d windows-wheels windows-wheels.zip
        unzip -d manylinux-wheels manylinux-wheels.zip

    - name: Install Twine
      run: pip install twine

    - name: Upload to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_REPO_TOKEN }}
      run: |
        python -m twine upload --repository-url https://test.pypi.org/legacy/ windows-wheels/*.whl manylinux-wheels/*.whl --verbose --disable-progress-bar
